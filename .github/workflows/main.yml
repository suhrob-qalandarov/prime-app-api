name: Build and Deploy Web App to Server

on:
  push:
    branches: [main]

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build JAR file
        run: ./mvnw clean package -DskipTests

      - name: Verify build artifacts
        run: |
          ls -l target/ || echo "target/ directory not found"
          ls -l target/app.jar || echo "app.jar not found"
          ls -l docker-compose.yml || echo "docker-compose.yml not found"
          ls -l Dockerfile || echo "Dockerfile not found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-files
          path: |
            target/app.jar
            docker-compose.yml
            docker-compose.blue.yml
            docker-compose.green.yml
            Dockerfile
            nginx/
            scripts/
          retention-days: 1

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-files

      - name: Prepare deployment files
        run: |
          # Move app.jar from target/ to root for deployment
          if [ -f "target/app.jar" ]; then
            cp target/app.jar app.jar
            echo "app.jar copied successfully"
          else
            echo "ERROR: target/app.jar not found!"
            exit 1
          fi
          ls -la app.jar

      - name: Setup deployment directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT || '22' }}
          script: |
            mkdir -p /home/${{ vars.HOST_USER }}/prime_app/nginx/conf.d
            mkdir -p /home/${{ vars.HOST_USER }}/prime_app/scripts

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          source: "app.jar,docker-compose.yml,docker-compose.blue.yml,docker-compose.green.yml,Dockerfile,nginx,scripts"
          target: /home/${{ vars.HOST_USER }}/prime_app
          port: ${{ vars.HOST_PORT || '22' }}
          timeout: 30s
          command_timeout: 10m
          debug: true
          strip_components: 0
          overwrite: true

      - name: Create .env file
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT || '22' }}
          script: |
            cd /home/${{ vars.HOST_USER }}/prime_app
            HOST_USER="${{ vars.HOST_USER }}"
            DATASOURCE_USER="${{ vars.DATASOURCE_USER }}"
            DATASOURCE_PASS="${{ vars.DATASOURCE_PASS }}"
            DATASOURCE_DRIVER="${{ vars.DATASOURCE_DRIVER }}"
            SERVER_PORT="${{ vars.SERVER_PORT }}"
            JPA_SHOW_SQL="${{ vars.JPA_SHOW_SQL }}"
            JPA_DIALECT="${{ vars.JPA_DIALECT }}"
            TGM_BOT_TOKEN="${{ vars.TGM_BOT_TOKEN }}"
            JWT_SECRET="${{ vars.JWT_SECRET }}"
            SWAGGER_UI_USERNAME="${{ vars.SWAGGER_UI_USERNAME }}"
            SWAGGER_UI_PASSWORD="${{ vars.SWAGGER_UI_PASSWORD }}"
            IP_WHITELIST_ENABLED="${{ vars.IP_WHITELIST_ENABLED }}"
            IP_WHITELIST="${{ vars.IP_WHITELIST }}"
            MAIN_URL="${{ vars.MAIN_URL }}"
            API_URL="${{ vars.API_URL }}"
            
            echo "SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/prime_db" > .env
            echo "SPRING_DATASOURCE_USERNAME=${DATASOURCE_USER}" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=${DATASOURCE_PASS}" >> .env
            echo "SPRING_DATASOURCE_DRIVER=${DATASOURCE_DRIVER:-org.postgresql.Driver}" >> .env
            echo "POSTGRES_DB=prime_db" >> .env
            echo "POSTGRES_USER=${DATASOURCE_USER}" >> .env
            echo "TELEGRAM_BOT_TOKEN=${TGM_BOT_TOKEN}" >> .env
            echo "JWT_SECRET_KEY=${JWT_SECRET}" >> .env
            echo "SERVER_PORT=${SERVER_PORT:-8080}" >> .env
            echo "JPA_SHOW_SQL=${JPA_SHOW_SQL:-false}" >> .env
            echo "JPA_DIALECT=${JPA_DIALECT:-org.hibernate.dialect.PostgreSQLDialect}" >> .env
            echo "SWAGGER_UI_USERNAME=${SWAGGER_UI_USERNAME}" >> .env
            echo "SWAGGER_UI_PASSWORD=${SWAGGER_UI_PASSWORD}" >> .env
            echo "IP_WHITELIST_ENABLED=${IP_WHITELIST_ENABLED:-false}" >> .env
            echo "IP_WHITELIST=${IP_WHITELIST:-}" >> .env
            echo "MAIN_URL=${MAIN_URL:-https://gourmet.uz}" >> .env
            echo "API_URL=${API_URL:-https://api.gourmet.uz}" >> .env

      - name: Start database (if not running)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT || '22' }}
          script: |
            cd /home/${{ vars.HOST_USER }}/prime_app
            # Ensure network exists
            docker network create app-network 2>/dev/null || echo "Network app-network already exists"
            docker compose up -d db || true

      - name: Deploy using blue-green script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT || '22' }}
          script: |
            cd /home/${{ vars.HOST_USER }}/prime_app
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT || '22' }}
          script: |
            sleep 5
            docker ps -a
            ACTIVE_ENV=$(cat /home/${{ vars.HOST_USER }}/prime_app/.active_env 2>/dev/null || echo "unknown")
            echo "Active environment: $ACTIVE_ENV"
            if [ "$ACTIVE_ENV" == "blue" ]; then
              echo "Application running on port: 8080"
            else
              echo "Application running on port: 8081"
            fi
