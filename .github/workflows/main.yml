name: Build and Deploy Web App to Server

on:
  push:
    branches: [main]

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build JAR file
        run: ./mvnw clean package -DskipTests

      - name: Verify build artifacts
        run: |
          ls -l target/ || echo "target/ directory not found"
          ls -l target/app.jar || echo "app.jar not found"
          ls -l docker-compose.yml || echo "docker-compose.yml not found"
          ls -l Dockerfile || echo "Dockerfile not found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-files
          path: |
            target/app.jar
            docker-compose.yml
            docker-compose.blue.yml
            docker-compose.green.yml
            Dockerfile
            nginx/
            scripts/
          retention-days: 1

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-files

      - name: Prepare deployment files
        run: |
          # Move app.jar from target/ to root for deployment
          if [ -f "target/app.jar" ]; then
            cp target/app.jar app.jar
            echo "app.jar copied successfully"
          else
            echo "ERROR: target/app.jar not found!"
            exit 1
          fi
          ls -la app.jar

      - name: Setup deployment directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT }}
          script: |
            mkdir -p /home/${{ vars.HOST_USER }}/${{ vars.APP_NAME }}/nginx/conf.d
            mkdir -p /home/${{ vars.HOST_USER }}/${{ vars.APP_NAME }}/scripts

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          source: ${{ vars.DEPLOYMENT_SOURCES }}
          target: /home/${{ vars.HOST_USER }}/${{ vars.APP_NAME }}
          port: ${{ vars.HOST_PORT }}
          timeout: 30s
          command_timeout: 10m
          debug: true
          strip_components: 0
          overwrite: true

      - name: Create .env file
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT }}
          script: |
            cd /home/${{ vars.HOST_USER }}/${{ vars.APP_NAME }}
            
            # Datasource variables
            echo "DATASOURCE_URL=${{ vars.DATASOURCE_URL }}" >> .env
            echo "DATASOURCE_USER=${{ vars.DATASOURCE_USER }}" >> .env
            echo "DATASOURCE_PASS=${{ vars.DATASOURCE_PASS }}" >> .env
            echo "DATASOURCE_DRIVER=${{ vars.DATASOURCE_DRIVER }}" >> .env
            echo "DATASOURCE_DB=${{ vars.DATASOURCE_DB }}" >> .env
            
            # JWT variables
            echo "JWT_SECRET=${{ vars.JWT_SECRET }}" >> .env
            echo "JWT_ACCESS_TOKEN_EXPIRY_DAYS=${{ vars.JWT_ACCESS_TOKEN_EXPIRY_DAYS }}" >> .env
            echo "JWT_DATA_EXPIRY_MINUTES=${{ vars.JWT_DATA_EXPIRY_MINUTES }}" >> .env
            echo "JWT_COUNTS_MAX_CATEGORY=${{ vars.JWT_COUNTS_MAX_CATEGORY }}" >> .env
            echo "JWT_COUNTS_MAX_PRODUCT=${{ vars.JWT_COUNTS_MAX_PRODUCT }}" >> .env
            echo "JWT_COUNTS_MAX_ATTACHMENT=${{ vars.JWT_COUNTS_MAX_ATTACHMENT }}" >> .env
            echo "JWT_COUNTS_MAX_CART=${{ vars.JWT_COUNTS_MAX_CART }}" >> .env
            
            # Telegram bot tokens
            echo "TG_BOT_U=${{ vars.TG_BOT_U }}" >> .env
            echo "TG_BOT_A=${{ vars.TG_BOT_A }}" >> .env
            
            # JPA variables
            echo "JPA_DDL=${{ vars.JPA_DDL }}" >> .env
            echo "JPA_SHOW_SQL=${{ vars.JPA_SHOW_SQL }}" >> .env
            echo "JPA_DIALECT=${{ vars.JPA_DIALECT }}" >> .env
            
            # Server variables
            echo "SERVER_PORT=${{ vars.SERVER_PORT }}" >> .env
            echo "WEBSITE_DOMAIN=${{ vars.WEBSITE_DOMAIN }}" >> .env
            
            # Cookie variables
            echo "COOKIE_TOKEN_NAME_USER=${{ vars.COOKIE_TOKEN_NAME_USER }}" >> .env
            echo "COOKIE_TOKEN_NAME_ADMIN=${{ vars.COOKIE_TOKEN_NAME_ADMIN }}" >> .env
            
            # Attachment variables
            echo "ATTACHMENT_FOLDER_PATH=${{ vars.ATTACHMENT_FOLDER_PATH }}" >> .env
            echo "ATTACHMENT_BASE_URL=${{ vars.ATTACHMENT_BASE_URL }}" >> .env
            
            # Swagger variables
            echo "SWAGGER_UI_USERNAME=${{ vars.SWAGGER_UI_USERNAME }}" >> .env
            echo "SWAGGER_UI_PASSWORD=${{ vars.SWAGGER_UI_PASSWORD }}" >> .env
            echo "SWAGGER_DOC_PRIMARY_NAME=${{ vars.SWAGGER_DOC_PRIMARY_NAME }}" >> .env
            echo "SWAGGER_DOC_HAS_PERSIST_AUTH=${{ vars.SWAGGER_DOC_HAS_PERSIST_AUTH }}" >> .env
            echo "SWAGGER_SERVER_LOCAL_URL=${{ vars.SWAGGER_SERVER_LOCAL_URL }}" >> .env
            
            # Application URLs
            echo "DOMAIN_MAIN_URL=${{ vars.DOMAIN_MAIN_URL }}" >> .env
            echo "DOMAIN_API_URL=${{ vars.DOMAIN_API_URL }}" >> .env
            echo "API_URL=${{ vars.API_URL }}" >> .env
            echo "LOCAL_URLS=${{ vars.LOCAL_URLS }}" >> .env
            
            # Logging
            echo "LOG_LEVEL=${{ vars.LOG_LEVEL }}" >> .env

      - name: Start database (if not running)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT }}
          script: |
            cd /home/${{ vars.HOST_USER }}/${{ vars.APP_NAME }}
            # Ensure network exists
            docker network create app-network 2>/dev/null || echo "Network app-network already exists"
            docker compose up -d db || true

      - name: Deploy using blue-green script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT }}
          script: |
            cd /home/${{ vars.HOST_USER }}/${{ vars.APP_NAME }}
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.HOST_IP }}
          username: ${{ vars.HOST_USER }}
          key: ${{ vars.HOST_SSH_KEY }}
          port: ${{ vars.HOST_PORT }}
          script: |
            sleep 5
            docker ps -a
            ACTIVE_ENV=$(cat /home/${{ vars.HOST_USER }}/${{ vars.APP_NAME }}/.active_env 2>/dev/null || echo "unknown")
            echo "Active environment: $ACTIVE_ENV"
            if [ "$ACTIVE_ENV" == "blue" ]; then
              echo "Application running on port: 8080"
            else
              echo "Application running on port: 8081"
            fi
